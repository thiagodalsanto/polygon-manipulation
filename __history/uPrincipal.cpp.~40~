//---------------------------------------------------------------------------

#include <vcl.h>
#pragma hdrstop

#include "ujanela.h"
#include "uPrincipal.h"
#include "uPonto.h"
#include "uPoligono.h"
#include "uDisplayFile.h"

//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma resource "*.dfm"
TForm1 *Form1;
Ponto aux;
Janela mundo(-250, -250, 250, 250);
Janela vp (0,0,500,500);
Poligono pol;
DisplayFile display;
int contaId = 0;
bool inicio = false;

//---------------------------------------------------------------------------
double TForm1::xVp2W(int x, Janela mundo, Janela vp){
  return (((x-vp.xmin)/(vp.xmax-vp.xmin)) *
		 (mundo.xmax - mundo.xmin)) + mundo.xmin;
}

double TForm1::yVp2W(int y, Janela mundo, Janela vp){
  return ((1-((y-vp.ymin)/(vp.ymax-vp.ymin))) *
		 (mundo.ymax - mundo.ymin)) + mundo.ymin;
}

__fastcall TForm1::TForm1(TComponent* Owner)
	: TForm(Owner)
{
  // eixo vertical
  pol.id     = contaId++;
  pol.tipo   = 'E';
  pol.pontos.push_back(Ponto(0, mundo.ymax));
  pol.pontos.push_back(Ponto(0, mundo.ymin));

  display.poligonos.push_back(pol);
  pol.pontos.clear();

  // eixo horizontal
  pol.id     = contaId++;
  pol.tipo   = 'E';
  pol.pontos.push_back(Ponto(mundo.xmin, 0));
  pol.pontos.push_back(Ponto(mundo.xmax, 0));

  display.poligonos.push_back(pol);
  pol.pontos.clear();

  display.mostra(lbPoligonos);
  display.desenha(Image1->Canvas, mundo, vp, rgTipoReta->ItemIndex);
}
//---------------------------------------------------------------------------



void __fastcall TForm1::Image1MouseMove(TObject *Sender, TShiftState Shift, int X,
		  int Y)
{
   double nx, ny;

   nx = xVp2W(X, mundo, vp);
   ny = yVp2W(Y, mundo, vp);

   lbVp->Caption = "(" + IntToStr(X) + "," +
						 IntToStr(Y) + ")";
   lbMundo->Caption = "(" + FloatToStr(nx) + "," +
							FloatToStr(ny) + ")";

}
//---------------------------------------------------------------------------

void __fastcall TForm1::Image1MouseDown(TObject *Sender, TMouseButton Button, TShiftState Shift,
		  int X, int Y)
{
	if (inicio)
	{
		if (Button == mbLeft)
		{
            UnicodeString a;

			aux.x = xVp2W(X, mundo, vp);
			aux.y = yVp2W(Y, mundo, vp);

			pol.pontos.push_back(aux);
			pol.desenha(Image1->Canvas, mundo, vp, rgTipoReta->ItemIndex);
		}
		else
		{
			if (Button == mbRight)
			{
                pol.id     = contaId++;
				pol.tipo   = 'P';

				display.poligonos.push_back(pol);
				pol.pontos.clear();

				display.mostra(lbPoligonos);
                inicio = false;
            }
        }
	}
	else
	{
        ShowMessage("Para começar um poligono clique no botao inicio");
    }

}
//---------------------------------------------------------------------------

void __fastcall TForm1::btInicioClick(TObject *Sender)
{
  inicio = true;
}
//---------------------------------------------------------------------------

void __fastcall TForm1::lbPoligonosClick(TObject *Sender)
{
    display.poligonos[lbPoligonos->ItemIndex].mostra(lbPontos);
}
//---------------------------------------------------------------------------

void __fastcall TForm1::Button1Click(TObject *Sender)
{
	mundo.xmin = StrToFloat(edxMin->Text);
	mundo.xmax = StrToFloat(edxMax->Text);
	mundo.ymin = StrToFloat(edyMin->Text);
	mundo.ymax = StrToFloat(edyMax->Text);

	display.poligonos[0].pontos[0].y = mundo.ymax;
	display.poligonos[0].pontos[1].y = mundo.ymin;

	display.poligonos[1].pontos[0].x = mundo.xmin;
	display.poligonos[1].pontos[1].x = mundo.xmax;

	display.desenha(Image1->Canvas, mundo, vp, rgTipoReta->ItemIndex);
}
//---------------------------------------------------------------------------



void __fastcall TForm1::rgTipoRetaClick(TObject *Sender)
{
	display.desenha(Image1->Canvas, mundo, vp, rgTipoReta->ItemIndex);
}
//---------------------------------------------------------------------------

